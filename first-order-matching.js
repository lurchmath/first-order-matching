var CLSetToString,CLToString,CToString,Constraint,ConstraintList,OM,OMNode,alphaEquivalent,applyExpressionFunction,bindingConstraints1,bindingConstraints2,clearMetavariable,composeIterator,concatenateIterators,consistentPatterns,differenceIterator,expressionDepth,expressionFunction,expressionFunctionApplication,filterIterator,findDifferencesBetween,isExpressionFunction,isExpressionFunctionApplication,isMetavariable,makeExpressionFunction,makeExpressionFunctionApplication,matchDebug,matchDebugOn,metavariableSymbol,multiReplace,nextMatch,parentAddresses,partitionedAddresses,prefixIterator,ref,sameDepthAncestors,satisfiesBindingConstraints1,satisfiesBindingConstraints2,setMatchDebug,setMetavariable,subexpressionIterator,suffixIterator,trueValue,slice=[].slice,indexOf=[].indexOf||function(t){for(var n=0,e=this.length;n<e;n++)if(n in this&&this[n]===t)return n;return-1};"undefined"!=typeof require&&null!==require&&(ref=require("openmath-js"),OM=ref.OM,OMNode=ref.OMNode),metavariableSymbol=OM.symbol("metavariable","FirstOrderMatching"),trueValue=OM.string("true"),setMetavariable=function(t){var n;if(t instanceof OMNode&&("v"===(n=t.type)||"sy"===n))return t.setAttribute(metavariableSymbol,trueValue.copy())},clearMetavariable=function(t){return t.removeAttribute(metavariableSymbol)},isMetavariable=function(t){var n,e;return t instanceof OMNode&&("v"===(n=t.type)||"sy"===n)&&(null!=(e=t.getAttribute(metavariableSymbol))?e.equals(trueValue):void 0)},expressionFunction=OM.symbol("EF","FirstOrderMatching"),expressionFunctionApplication=OM.symbol("EFA","FirstOrderMatching"),makeExpressionFunction=function(t,n){if("v"!==t.type)throw"When creating an expression function, its parameter must be a variable";return OM.bin(expressionFunction,t,n)},isExpressionFunction=function(t){return"bi"===t.type&&1===t.variables.length&&t.symbol.equals(expressionFunction)},makeExpressionFunctionApplication=function(t,n){return OM.app(expressionFunctionApplication,t,n)},isExpressionFunctionApplication=function(t){return"a"===t.type&&3===t.children.length&&t.children[0].equals(expressionFunctionApplication)},applyExpressionFunction=function(t,n){var e;return(e=t.body.copy()).replaceFree(t.variables[0],n),e},alphaEquivalent=function(t,n){var e,r,i,s,a,o;for(i=0,a=function(){return OM.var("v"+i)},s=function(t){return t.equals(a())},o=OM.app(t,n);o.hasDescendantSatisfying(s);)i++;return e=applyExpressionFunction(t,a()),r=applyExpressionFunction(n,a()),isExpressionFunction(t)&&isExpressionFunction(n)&&e.equals(r)},consistentPatterns=function(){var t,n,e,r,i,s,a,o,u,l,c,p,f;for(a=[],n=[],e=0,i=(o=1<=arguments.length?slice.call(arguments,0):[]).length;e<i;e++)for(r=0,s=(u=o[e].descendantsSatisfying(isMetavariable)).length;r<s;r++)if(t=u[r],isExpressionFunctionApplication(t.parent)&&"c1"===t.findInParent()){if(l=t.name,indexOf.call(a,l)>=0)return!1;c=t.name,indexOf.call(n,c)<0&&n.push(t.name)}else{if(p=t.name,indexOf.call(n,p)>=0)return!1;f=t.name,indexOf.call(a,f)<0&&a.push(t.name)}return!0},Constraint=function(){function t(t,n){this.pattern=t,this.expression=n}return t.prototype.copy=function(){return new t(this.pattern.copy(),this.expression.copy())},t.prototype.equals=function(t){return this.pattern.equals(t.pattern,!1)&&this.expression.equals(t.expression,!1)},t}(),ConstraintList=function(){function t(){var t,n,e,r,i,s,a,o,u,l,c,p,f;for(e=1<=arguments.length?slice.call(arguments,0):[],this.contents=e,this.nextNewVariableIndex=0,t=function(t){return function(n){if(/^v[0-9]+$/.test(n.name))return t.nextNewVariableIndex=Math.max(t.nextNewVariableIndex,parseInt(n.name.slice(1))+1)}}(this),f=function(t){return t.descendantsSatisfying(function(t){return"v"===t.type})},r=0,a=(l=this.contents).length;r<a;r++){for(i=0,o=(c=f((n=l[r]).pattern)).length;i<o;i++)t(c[i]);for(s=0,u=(p=f(n.expression)).length;s<u;s++)t(p[s])}}return t.prototype.nextNewVariable=function(){return OM.simple("v"+this.nextNewVariableIndex++)},t.prototype.length=function(){return this.contents.length},t.prototype.copy=function(){var n,e;return e=function(t,n,e){e.prototype=t.prototype;var r=new e,i=t.apply(r,n);return Object(i)===i?i:r}(t,function(){var t,e,r,i;for(i=[],t=0,e=(r=this.contents).length;t<e;t++)n=r[t],i.push(n.copy());return i}.call(this),function(){}),e.nextNewVariableIndex=this.nextNewVariableIndex,e},t.prototype.indexAtWhich=function(t){var n,e,r,i,s;for(e=r=0,i=(s=this.contents).length;r<i;e=++r)if(n=s[e],t(n))return e;return-1},t.prototype.plus=function(){var t,n,e,r,i;for(n=1<=arguments.length?slice.call(arguments,0):[],i=this.copy(),e=0,r=n.length;e<r;e++)t=n[e],-1===i.indexAtWhich(function(n){return n.equals(t,!1)})&&i.contents.push(t);return i},t.prototype.minus=function(){var t,n,e,r,i,s;for(n=1<=arguments.length?slice.call(arguments,0):[],s=this.copy(),r=0,i=n.length;r<i;r++)t=n[r],(e=s.indexAtWhich(function(n){return n.equals(t,!1)}))>-1&&s.contents.splice(e,1);return s},t.prototype.firstSatisfying=function(t){var n;return null!=(n=this.contents[this.indexAtWhich(t)])?n:null},t.prototype.firstPairSatisfying=function(t){var n,e,r,i,s,a,o,u,l,c;for(r=s=0,o=(l=this.contents).length;s<o;r=++s)for(n=l[r],i=a=0,u=(c=this.contents).length;a<u;i=++a)if(e=c[i],r!==i&&t(n,e))return[n,e];return null},t.prototype.isFunction=function(){var t,n,e,r,i,s;for(s=[],n=0,e=(r=this.contents).length;n<e;n++){if(t=r[n],!isMetavariable(t.pattern))return!1;if(i=t.pattern.name,indexOf.call(s,i)>=0)return!1;s.push(t.pattern.name)}return!0},t.prototype.lookup=function(t){var n,e,r,i;for(t instanceof OM||(t=OM.var(t)),setMetavariable(t),e=0,r=(i=this.contents).length;e<r;e++)if((n=i[e]).pattern.equals(t,!1))return n.expression;return null},t.prototype.apply=function(t){var n,e,r,i,s,a;for(n=0,e=(i=(s=t.copy()).descendantsSatisfying(isMetavariable)).length;n<e;n++)r=i[n],null!=(a=this.lookup(r))&&r.replaceWith(a);return s},t.prototype.equals=function(t){var n,e,r,i,s,a,o;for(e=0,i=(a=this.contents).length;e<i;e++)if(n=a[e],!t.firstSatisfying(function(t){return t.equals(n)}))return!1;for(r=0,s=(o=t.contents).length;r<s;r++)if(n=o[r],!this.firstSatisfying(function(t){return t.equals(n)}))return!1;return!0},t}(),findDifferencesBetween=function(t,n){var e,r;return e=[],(r=function(n,i){var s,a,o,u,l,c,p;if(n.type!==i.type)return e.push(n.address(t));if("bi"===n.type?(s=[n.symbol].concat(slice.call(n.variables),[n.body]),a=[i.symbol].concat(slice.call(i.variables),[i.body])):(s=n.children,a=i.children),s.length!==a.length||s.length+a.length===0&&!n.equals(i,!1))return e.push(n.address(t));for(p=[],u=l=0,c=s.length;l<c;u=++l)o=s[u],p.push(r(o,a[u]));return p})(t,n),e},parentAddresses=function(t){var n,e,r,i,s,a,o,u;for(a=[],e=0,i=t.length;e<i;e++)0!==(n=t[e]).length&&(u=JSON.stringify(n.slice(0,-1)),indexOf.call(a,u)<0&&a.push(u));if(0===a.length)return null;for(o=[],r=0,s=a.length;r<s;r++)n=a[r],o.push(JSON.parse(n));return o},partitionedAddresses=function(t){var n,e;return n=[],(e=function(r){var i,s,a,o,u,l,c,p,f;for(s=!1,a=0,u=n.length;a<u;a++)if(c=n[a],r.equals(c.subexpression,!1)){c.addresses.push(r.address(t)),s=!0;break}for(s||n.push({subexpression:r,addresses:[r.address(t)]}),f=[],o=0,l=(p=r.children).length;o<l;o++)i=p[o],f.push(e(i));return f})(t),n},expressionDepth=function(t){var n,e;return e=slice.call(t.children).concat(slice.call(t.variables)),t.body&&e.push(t.body),t.symbol&&e.push(t.symbol),1+Math.max.apply(Math,[0].concat(slice.call(function(){var t,r,i;for(i=[],t=0,r=e.length;t<r;t++)n=e[t],i.push(expressionDepth(n));return i}())))},sameDepthAncestors=function(t,n){var e,r,i,s,a,o,u,l,c,p,f,h,x,g,d,b,m,v,y,C,S;for(u=c=0,h=n.length;c<h;u=++c)for(r=n[u],s=expressionDepth(t.index(r)),l=p=0,x=n.length;p<x;l=++p)if(i=n[l],a=expressionDepth(t.index(i)),s!==a)return s>a&&(r=(m=[i,r])[0],i=m[1],u=(v=[l,u])[0],l=v[1]),r.slice(0,-1),o=n.slice(0),o[u]=r.slice(0,-1),sameDepthAncestors(t,o);for(y=[],f=0,g=n.length;f<g;f++)e=n[f],S=JSON.stringify(e),indexOf.call(y,S)<0&&y.push(S);for(C=[],b=0,d=y.length;b<d;b++)S=y[b],C.push(JSON.parse(S));return C},differenceIterator=function(t,n){var e,r;return r=sameDepthAncestors(t,findDifferencesBetween(t,n)),e=function(e){var r,i,s,a,o,u;for(s=0,o=e.length;s<o;s++)for(r=e[s],a=0,u=e.length;a<u;a++){if(i=e[a],!t.index(r).equals(t.index(i),!1))return!1;if(!n.index(r).equals(n.index(i),!1))return!1}return!0},function(){for(var n,i;null!=r&&!e(r);)n=parentAddresses(r),r=n&&sameDepthAncestors(t,n);return null!==(i=r)&&(n=parentAddresses(r),r=n&&sameDepthAncestors(t,n)),i}},subexpressionIterator=function(t){var n,e,r;return e=partitionedAddresses(t),r={next:e.shift(),rest:e,subsetIndex:1},n=function(){var e,i,s;return matchDebug("\t\tsubexpression iterator for",t.simpleEncode(),"next:",JSON.stringify(r.next.addresses),"rest:",JSON.stringify(function(){var t,n,e,i;for(i=[],t=0,n=(e=r.rest).length;t<n;t++)s=e[t],i.push(s.addresses);return i}()),"subsetIndex:",r.subsetIndex),r.subsetIndex<Math.pow(2,r.next.addresses.length)?(i=function(){var t,n,i;for(i=[],e=t=0,n=r.next.addresses.length;0<=n?t<n:t>n;e=0<=n?++t:--t)0<(r.subsetIndex&Math.pow(2,e))&&i.push(r.next.addresses[e]);return i}(),r.subsetIndex++,i):r.rest.length>0?(r.next=r.rest.shift(),r.subsetIndex=1,n()):null}},prefixIterator=function(t,n){var e;return e=!1,function(){return e?n():(e=!0,t)}},suffixIterator=function(t,n){var e;return e=!1,function(){var r;return null!==(r=t())||e||(r=n,e=!0),r}},composeIterator=function(t,n){return function(){var e;return(e=t())?n(e):null}},filterIterator=function(t,n){return function(){var e;for(e=t();e&&!n(e);)e=t();return e}},concatenateIterators=function(t,n){return function(){return t()||n()}},multiReplace=function(t,n,e){var r,i,s,a,o;for(o=t.copy(),i=0,s=n.length;i<s;i++)r=n[i],null!=(a=o.index(r))&&a.replaceWith(e.copy());return o},bindingConstraints1=function(t){var n,e,r,i,s,a,o,u,l,c,p,f,h,x,g,d;for(g=new ConstraintList,r=function(t){return"bi"===t.type},i=0,o=(f=t.descendantsSatisfying(r)).length;i<o;i++)for(s=0,u=(h=(e=f[i]).descendantsSatisfying(isMetavariable)).length;s<u;s++)if((c=h[s]).isFree(e))for(a=0,l=(x=e.variables).length;a<l;a++)d=x[a],isMetavariable(d)&&(p=new Constraint(d,c),n=function(t){return t.equals(p)},g.firstSatisfying(n)||g.contents.push(p));return g},satisfiesBindingConstraints1=function(t,n){var e,r,i,s,a;for(r=0,i=(s=n.contents).length;r<i;r++)if(e=s[r],a=t.lookup(e.pattern),t.lookup(e.expression).copy().occursFree(a))return!1;return!0},bindingConstraints2=function(t){var n,e,r,i,s,a;for(a=new ConstraintList,e=0,r=(s=t.descendantsSatisfying(isExpressionFunctionApplication)).length;e<r;e++)n=s[e],isMetavariable(n.children[1])&&(i=function(t,n,e){e.prototype=t.prototype;var r=new e,i=t.apply(r,n);return Object(i)===i?i:r}(Constraint,n.children.slice(1,3),function(){}),a.firstSatisfying(function(t){return t.equals(i)})||a.contents.push(i));return a},satisfiesBindingConstraints2=function(t,n){var e,r,i,s,a,o,u,l,c,p,f;for(a=0,u=(c=n.contents).length;a<u;a++)for(i=c[a],null==(s=t.lookup(i.pattern))&&matchDebug(CLToString(t),CLToString(n)),e=t.apply(i.expression),r=function(t){return t.equals(s.variables[0])},o=0,l=(p=s.body.descendantsSatisfying(r)).length;o<l;o++)if(f=p[o],!e.isFreeToReplace(f,s.body))return!1;return!0},CToString=function(t){return"("+t.pattern.simpleEncode()+","+t.expression.simpleEncode()+")"},CLToString=function(t){var n;return null===t?null:"{ "+function(){var e,r,i,s;for(s=[],e=0,r=(i=t.contents).length;e<r;e++)n=i[e],s.push(CToString(n));return s}().join(", ")+" }"},CLSetToString=function(t){var n;return null===t?null:"[\n"+function(){var e,r,i;for(i=[],e=0,r=t.length;e<r;e++)n=t[e],i.push("\t"+CLToString(n));return i}().join("\n")+"\n]"},matchDebugOn=!1,setMatchDebug=function(t){return matchDebugOn=t},matchDebug=function(){var t;if(t=1<=arguments.length?slice.call(arguments,0):[],matchDebugOn)return console.log.apply(console,t)},nextMatch=function(t,n,e){var r,i,s,a,o,u,l,c,p,f,h,x,g,d,b,m,v,y,C,S,M,I,E,D,F,A,O,q,w,T;if(null==n&&(n=new ConstraintList),null==e&&(e=null),t instanceof Constraint&&(t=new ConstraintList(t)),!(t instanceof ConstraintList))throw"Invalid first parameter, not a constraint list";if(matchDebug("\nmatchDebug",CLToString(t),CLToString(n),null!=e?"  ...ITERATOR...":""),null==e){if(0===t.length())return matchDebug("\tbase case, returning:",CLToString(n)),[n,null];if(null!=(l=t.firstSatisfying(function(t){return 0===t.pattern.children.length&&0===t.pattern.variables.length&&!isMetavariable(t.pattern)})))return l.pattern.equals(l.expression,!1)?(matchDebug("\tatomic case, recur:",CToString(l)),nextMatch(t.minus(l),n,e)):(matchDebug("\tatomic case, return null for",CToString(l)),[null,null]);if(E=function(t){return"bi"===t.type?[t.symbol].concat(slice.call(t.variables),[t.body]):t.children},null!=(l=t.firstSatisfying(function(t){return E(t.pattern).length>0&&!isExpressionFunctionApplication(t.pattern)})))return r=l.pattern,i=l.expression,r.type!==i.type?(matchDebug("\tnon-atomic case, type fail:",CToString(l)),[null,null]):(x=E(r),A=E(i),x.length!==A.length?(matchDebug("\tnon-atomic case, #children fail:",CToString(l)),[null,null]):(t=(D=t.minus(l)).plus.apply(D,function(){var t,n,e;for(e=[],h=t=0,n=x.length;t<n;h=++t)u=x[h],e.push(new Constraint(u,A[h]));return e}()),matchDebug("\tnon-atomic case, recur:",CToString(l)),nextMatch(t,n,e)));if(null!=(l=t.firstSatisfying(function(t){return isMetavariable(t.pattern)}))){if(s=n.lookup(l.pattern)){if(!l.expression.equals(s,!1))return matchDebug("\tmetavariable case, mismatch:",CToString(l)),[null,null];matchDebug("\tmetavariable case, already set:",CToString(l))}else matchDebug("\tmetavariable case, assigning:",CToString(l)),n=n.plus(l.copy());return nextMatch(t.minus(l),n,e)}if(null!=(I=t.firstPairSatisfying(function(t,n){return isExpressionFunctionApplication(t.pattern)&&isExpressionFunctionApplication(n.pattern)&&t.pattern.children[1].equals(n.pattern.children[1],!1)&&!t.expression.equals(n.expression,!1)})))return a=I[0],o=I[1],O=t.minus(a,o),b=a.pattern.children[1],w=a.pattern.children[2],T=o.pattern.children[2],p=a.expression,f=o.expression,d=function(n){var e;return e=t.nextNewVariable(),makeExpressionFunction(e,multiReplace(p,n,e))},e=differenceIterator(p,f),e=filterIterator(e,function(t){var e;return null==(e=n.lookup(b))||alphaEquivalent(e,d(t))}),e=composeIterator(e,function(t){var e;return e=n.lookup(b)?n.copy():n.plus(new Constraint(b,d(t))),[O.plus(new Constraint(w,p.index(t[0])),new Constraint(T,f.index(t[0]))),e,null]}),matchDebug("\tefa case 1 of 2, iterating:",CToString(a),CToString(o)),nextMatch(O,n,e);if(null!=(I=t.firstPairSatisfying(function(t,n){return isExpressionFunctionApplication(t.pattern)&&isExpressionFunctionApplication(n.pattern)&&t.pattern.children[1].equals(n.pattern.children[1],!1)&&t.expression.equals(n.expression,!1)})))return a=I[0],o=I[1],O=t.minus(a,o),b=a.pattern.children[1],w=a.pattern.children[2],T=o.pattern.children[2],c=a.expression,d=function(n){var e;return e=t.nextNewVariable(),makeExpressionFunction(e,multiReplace(c,n,e))},e=subexpressionIterator(c),e=filterIterator(e,function(t){var e;return null==(e=n.lookup(b))||alphaEquivalent(e,d(t))}),e=suffixIterator(e,[]),e=composeIterator(e,function(t){var e,r,i,s;if(i=d(t),s=n.lookup(b)){if(!alphaEquivalent(s,i))return null;e=n.copy()}else e=n.plus(new Constraint(b,i));return r=O,0!==t.length&&(r=r.plus(new Constraint(w,c.index(t[0])),new Constraint(T,c.index(t[0])))),[r,e,null]}),matchDebug("\tefa case 2 of 2, iterating:",CToString(a),CToString(o)),nextMatch(O,n,e);if(l=t.contents[0],!isExpressionFunctionApplication(l.pattern))throw Error("Invalid assumption in final case of matching");return O=t.minus(l),b=l.pattern.children[1],q=l.pattern.children[2],c=l.expression,(g=n.lookup(b))?(applyExpressionFunction(g,q),matchDebug("\tfinal case, applying known metavariable:",CToString(l)),nextMatch(O.plus(new Constraint(g,c)),n,e)):(d=function(n){var e;return e=t.nextNewVariable(),makeExpressionFunction(e,multiReplace(c,n,e))},e=subexpressionIterator(c),e=filterIterator(e,function(t){return null==(g=n.lookup(b))||alphaEquivalent(g,d(t))}),e=suffixIterator(e,[]),e=composeIterator(e,function(t){var e,r,i,s;if(matchDebug("\t\tnext subexpression, with subset",JSON.stringify(t),"solution",CLToString(n),"constraints",CLToString(O),"t",q.simpleEncode(),"e",c.simpleEncode(),"metavariable",b.simpleEncode()),i=d(t),s=n.lookup(b)){if(!alphaEquivalent(s,i))return null;e=n.copy()}else e=n.plus(new Constraint(b,i));return r=O,0!==t.length&&(r=r.plus(new Constraint(q,c.index(t[0])))),[r,e,null]}),matchDebug("\tfinal case, iterating:",CToString(l)),nextMatch(O,n,e))}return null===(m=e())?(matchDebug("\titerator case, next is null, done!"),[null,null]):(y=m[0],M=m[1],C=m[2],matchDebug("\titerator case, using iterator.next():",CLToString(y),CLToString(M),null!=C,"\n---\x3e"),F=nextMatch(y,M,C),S=F[0],v=F[1],null==S?(matchDebug("\n<---\n\tafter iterator recursion, no result; keep iterating..."),nextMatch(t,n,e)):null==v?(matchDebug("\n<---\n\tafter iterator recursion, got a unique solution:",CLToString(S)),[S,[t,n,e]]):(matchDebug("\n<---\n\tafter iterator recursion, got a(nother?) solution:",CLToString(S),"PLUS nextArguments",CLToString(v[0]),CLToString(v[1]),null!=v[2]),v[2]=concatenateIterators(v[2],e),[S,v]))},"undefined"!=typeof exports&&null!==exports&&(exports.setMetavariable=setMetavariable,exports.clearMetavariable=clearMetavariable,exports.isMetavariable=isMetavariable,exports.makeExpressionFunction=makeExpressionFunction,exports.isExpressionFunction=isExpressionFunction,exports.makeExpressionFunctionApplication=makeExpressionFunctionApplication,exports.isExpressionFunctionApplication=isExpressionFunctionApplication,exports.applyExpressionFunction=applyExpressionFunction,exports.alphaEquivalent=alphaEquivalent,exports.consistentPatterns=consistentPatterns,exports.Constraint=Constraint,exports.ConstraintList=ConstraintList,exports.findDifferencesBetween=findDifferencesBetween,exports.parentAddresses=parentAddresses,exports.partitionedAddresses=partitionedAddresses,exports.expressionDepth=expressionDepth,exports.sameDepthAncestors=sameDepthAncestors,exports.differenceIterator=differenceIterator,exports.subexpressionIterator=subexpressionIterator,exports.prefixIterator=prefixIterator,exports.suffixIterator=suffixIterator,exports.composeIterator=composeIterator,exports.filterIterator=filterIterator,exports.concatenateIterators=concatenateIterators,exports.multiReplace=multiReplace,exports.bindingConstraints1=bindingConstraints1,exports.satisfiesBindingConstraints1=satisfiesBindingConstraints1,exports.bindingConstraints2=bindingConstraints2,exports.satisfiesBindingConstraints2=satisfiesBindingConstraints2,exports.setMatchDebug=setMatchDebug,exports.nextMatch=nextMatch,exports.OM=exports.OMNode=OM);
//# sourceMappingURL=first-order-matching.js.map
